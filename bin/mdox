#!/usr/bin/env node

var program = require('commander');
var pkg = require('../package');
var util = require('util');
var mdox = require('..');

// options

program
    .version(pkg.version)
    .option('-h, --html', 'output "raw" comments, leaving the markdown intact')
    .option('-d, --debug', 'output parsed comments for debugging')
    .option('-m, --md', 'output markdown documentation');

// examples

program.on('--help', function(){
    console.log('  Examples:');
    console.log('');
    console.log('    # stdin');
    console.log('    $ mdox > myfile.json');
    console.log('');
    console.log('    # operates over stdio');
    console.log('    $ mdox < myfile.js > myfile.json');
    console.log('');
});

program.parse(process.argv);

var buf = '';
process.stdin.setEncoding('utf8');
process.stdin.on('data', function(chunk) {
    buf += chunk;
});

process.stdin.on('end', function() {
    var data;

    if (program.md) {
        data = mdox.mdGenerate(buf, {
            html: program.html
        });

        process.stdout.write(data);

    } else {
        data = mdox.jsonGenerate(buf, {
            html: program.html
        });

        if (program.debug) {
            process.stdout.write(util.inspect(data, {
                showHidden: false,
                depth: Infinity,
                colors: true
            }) + '\n');

        } else {
            process.stdout.write(JSON.stringify(data, null, 4));
        }
    }

}).resume();
